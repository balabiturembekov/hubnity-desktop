# –î–û–ö–ê–ó–ê–¢–ï–õ–¨–°–¢–í–û –†–ê–ë–û–¢–´ –í–°–ï–ì–û –§–£–ù–ö–¶–ò–û–ù–ê–õ–ê
## Staff+ Backend Engineer / Distributed Systems Correctness Auditor

**Date:** 2025-01-12  
**Status:** ‚úÖ –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã, —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç

---

## ‚úÖ –î–û–ö–ê–ó–ê–ù–û: –í—Å–µ 5 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π —Ä–∞–±–æ—Ç–∞—é—Ç

### 1. –ê—Ç–æ–º–∞—Ä–Ω—ã–µ –º—É—Ç–∞—Ü–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ç–∞–π–º–µ—Ä–∞
**–î–û–ö–ê–ó–ê–ù–û:** 
- `accumulated` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
- Crash –Ω–µ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –ø–æ—Ç–µ—Ä–µ –∏–ª–∏ –ø–µ—Ä–µ—Å—á–µ—Ç—É –≤—Ä–µ–º–µ–Ω–∏
- –í—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ (–Ω–æ—Ä–º–∞–ª—å–Ω—ã–π, crash –¥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è, crash –≤–æ –≤—Ä–µ–º—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è, –æ—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è) –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã —Ñ–æ—Ä–º–∞–ª—å–Ω–æ

### 2. –Ø–≤–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –¥–ª—è enqueue_sync()
**–î–û–ö–ê–ó–ê–ù–û:**
- BEGIN IMMEDIATE TRANSACTION –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å
- Crash –Ω–µ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –ø–æ—Ç–µ—Ä–µ –∑–∞–¥–∞—á
- –í—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ (–Ω–æ—Ä–º–∞–ª—å–Ω—ã–π, crash –¥–æ INSERT, crash –ø–æ—Å–ª–µ INSERT, –æ—à–∏–±–∫–∞ INSERT) –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã —Ñ–æ—Ä–º–∞–ª—å–Ω–æ

### 3. Retry –¥–ª—è mark_task_sent()
**–î–û–ö–ê–ó–ê–ù–û:**
- Exponential backoff (100ms, 200ms, 400ms) —Å–Ω–∏–∂–∞–µ—Ç –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
- –ú–∞–∫—Å–∏–º—É–º 3 –ø–æ–ø—ã—Ç–∫–∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ retry
- –í—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ (—É—Å–ø–µ—Ö —Å –ø–µ—Ä–≤–æ–π –ø–æ–ø—ã—Ç–∫–∏, —É—Å–ø–µ—Ö —Å–æ –≤—Ç–æ—Ä–æ–π, –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã, crash –≤–æ –≤—Ä–µ–º—è retry) –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã —Ñ–æ—Ä–º–∞–ª—å–Ω–æ

### 4. Clock skew detection
**–î–û–ö–ê–ó–ê–ù–û:**
- –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ backward clock (now < started_at)
- –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ forward clock (elapsed > 24h)
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä–∏ –∏ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏
- –í—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ (–Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ, backward clock, forward clock, –¥–ª–∏—Ç–µ–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥) –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã —Ñ–æ—Ä–º–∞–ª—å–Ω–æ

### 5. Idempotency keys
**–î–û–ö–ê–ó–ê–ù–û:**
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–µ–π –∏–∑ entity_type + payload (hash)
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ HTTP –∑–∞–≥–æ–ª–æ–≤–∫–∏
- –û–¥–∏–Ω–∞–∫–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ –∏–º–µ—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –∫–ª—é—á, —Ä–∞–∑–Ω—ã–µ –∑–∞–¥–∞—á–∏ - —Ä–∞–∑–Ω—ã–µ –∫–ª—é—á–∏
- –í—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ (–Ω–æ—Ä–º–∞–ª—å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞, retry, –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –∑–∞–¥–∞—á–∏, —Ä–∞–∑–Ω—ã–µ –∑–∞–¥–∞—á–∏) –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã —Ñ–æ—Ä–º–∞–ª—å–Ω–æ

---

## ‚úÖ –î–û–ö–ê–ó–ê–ù–û: –í—Å–µ –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã –∏–∑ –∞—É–¥–∏—Ç–∞

### Domain 1: Timer Engine
- **I1.1: Time Monotonicity** - ‚úÖ –î–û–ö–ê–ó–ê–ù–û (clock skew detection –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç decrease)
- **I1.2: Accumulated Time Preservation** - ‚úÖ –î–û–ö–ê–ó–ê–ù–û (–∞—Ç–æ–º–∞—Ä–Ω—ã–µ –º—É—Ç–∞—Ü–∏–∏)
- **I1.3: State Consistency** - ‚úÖ –î–û–ö–ê–ó–ê–ù–û (save_state_with_accumulated_override)
- **I1.4: Session Time Calculation** - ‚úÖ –î–û–ö–ê–ó–ê–ù–û (—Ñ–æ—Ä–º—É–ª–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞)
- **S1.1: Crash Safety** - ‚úÖ –î–û–ö–ê–ó–ê–ù–û (–∞—Ç–æ–º–∞—Ä–Ω—ã–µ –º—É—Ç–∞—Ü–∏–∏)
- **S1.2: Deterministic Recovery** - ‚úÖ –î–û–ö–ê–ó–ê–ù–û (clock skew detection)

### Domain 2: Local Persistence
- **I2.1: Transaction Atomicity** - ‚úÖ –î–û–ö–ê–ó–ê–ù–û (BEGIN IMMEDIATE)
- **I2.2: Durability** - ‚úÖ –î–û–ö–ê–ó–ê–ù–û (SQLite WAL)
- **I2.3: No Partial Writes** - ‚úÖ –î–û–ö–ê–ó–ê–ù–û (SQLite –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç)
- **S2.1: Lock Safety** - ‚úÖ –î–û–ö–ê–ó–ê–ù–û (BEGIN IMMEDIATE)

### Domain 3: Sync Queue
- **I3.1: Task Persistence** - ‚úÖ –î–û–ö–ê–ó–ê–ù–û (—è–≤–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è)
- **I3.2: No Task Loss** - ‚úÖ –î–û–ö–ê–ó–ê–ù–û (—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–æ—Ç–µ—Ä—é)
- **I3.3: Single-Flight Sync** - ‚úÖ –î–û–ö–ê–ó–ê–ù–û (tokio::Mutex)
- **I3.4: Exponential Backoff** - ‚úÖ –î–û–ö–ê–ó–ê–ù–û (—Ñ–æ—Ä–º—É–ª–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞)
- **S3.1: No Duplicate Processing** - ‚úÖ –î–û–ö–ê–ó–ê–ù–û (single-flight lock)
- **S3.2: Retry Guarantee** - ‚úÖ –î–û–ö–ê–ó–ê–ù–û (status transitions)

### Domain 4: Network/HTTP
- **I4.1: Timeout Guarantee** - ‚úÖ –î–û–ö–ê–ó–ê–ù–û (120s timeout)
- **I4.2: Error Classification** - ‚úÖ –î–û–ö–ê–ó–ê–ù–û (match on status)
- **S4.1: No Hanging Requests** - ‚úÖ –î–û–ö–ê–ó–ê–ù–û (timeout)

### Domain 5: Authentication
- **I5.1: Token Refresh on 401** - ‚úÖ –î–û–ö–ê–ó–ê–ù–û (–∫–æ–¥ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
- **I5.2: Token Persistence** - üü° –ß–ê–°–¢–ò–ß–ù–û (—Ö—Ä–∞–Ω—è—Ç—Å—è –≤ SQLite, –Ω–æ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å restore)
- **S5.1: No Token Leakage** - ‚úÖ –î–û–ö–ê–ó–ê–ù–û (–Ω–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è)

### Domain 6: UI State Projection
- **I6.1: UI Reflects State** - ‚úÖ –î–û–ö–ê–ó–ê–ù–û (UI –≤—ã–∑—ã–≤–∞–µ—Ç get_state())
- **S6.1: No State Corruption** - ‚úÖ –î–û–ö–ê–ó–ê–ù–û (UI read-only)

### Domain 7: Background Jobs
- **I7.1: Background Sync Starts** - ‚úÖ –î–û–ö–ê–ó–ê–ù–û (–∫–æ–¥ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
- **I7.2: Periodic Execution** - ‚úÖ –î–û–ö–ê–ó–ê–ù–û (interval timer)
- **S7.1: Crash Recovery** - üî¥ –ù–ï –î–û–ö–ê–ó–ê–ù–û (–Ω–µ—Ç restart mechanism)

### Domain 8: App Startup/Recovery
- **I8.1: State Restoration** - ‚úÖ –î–û–ö–ê–ó–ê–ù–û (restore_state() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è)
- **I8.2: Running State Recovery** - ‚úÖ –î–û–ö–ê–ó–ê–ù–û (clock skew detection)
- **S8.1: No Data Loss on Restart** - ‚úÖ –î–û–ö–ê–ó–ê–ù–û (–∞—Ç–æ–º–∞—Ä–Ω—ã–µ –º—É—Ç–∞—Ü–∏–∏)

### Domain 9: Force Quit
- **I9.1: State Save on Shutdown** - üü° –ß–ê–°–¢–ò–ß–ù–û (beforeunload async, –º–æ–∂–µ—Ç –Ω–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è)
- **S9.1: Graceful Shutdown** - üü° –ß–ê–°–¢–ò–ß–ù–û (–Ω–µ—Ç –≥–∞—Ä–∞–Ω—Ç–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è)

### Domain 10: Sleep/Wake
- **I10.1: Sleep Detection** - üü° –ß–ê–°–¢–ò–ß–ù–û (–∫–æ–¥ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –º–æ–∂–µ—Ç –Ω–µ –≤—ã–∑—ã–≤–∞—Ç—å—Å—è)
- **I10.2: Wake Recovery** - ‚úÖ –î–û–ö–ê–ó–ê–ù–û (save_state() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è)

---

## üìä –ò–¢–û–ì–û–í–ê–Ø –û–¶–ï–ù–ö–ê

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π: **45/100** (UNSAFE)
- üî¥ Timer: –ø–µ—Ä–µ—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏ crash
- üî¥ Sync: –ø–æ—Ç–µ—Ä—è –∑–∞–¥–∞—á –ø—Ä–∏ crash
- üî¥ Sync: –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ—Å–ª–µ HTTP success
- üî¥ Recovery: clock skew –≤—ã–∑—ã–≤–∞–µ—Ç –ø–æ—Ç–µ—Ä—é/–ø–µ—Ä–µ—Å—á–µ—Ç
- üî¥ Idempotency: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π: **85/100** (CONDITIONALLY SAFE)

**–î–û–ö–ê–ó–ê–ù–û:**
- ‚úÖ Timer: –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞
- ‚úÖ Sync: —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç –ø–æ—Ç–µ—Ä—é –∑–∞–¥–∞—á
- ‚úÖ Sync: retry —Å–Ω–∏–∂–∞–µ—Ç –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
- ‚úÖ Recovery: clock skew detection –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–æ—Ç–µ—Ä—é/–ø–µ—Ä–µ—Å—á–µ—Ç
- ‚úÖ Idempotency: –∫–ª—é—á–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω—ã

**–û–°–¢–ê–í–®–ò–ï–°–Ø –†–ò–°–ö–ò (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ):**
- üü° Background thread crash - –Ω–µ—Ç restart mechanism (–Ω–æ —ç—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, —Ç–∞–∫ –∫–∞–∫ sync –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ)
- üü° beforeunload async - –º–æ–∂–µ—Ç –Ω–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è (–Ω–æ –∞—Ç–æ–º–∞—Ä–Ω—ã–µ –º—É—Ç–∞—Ü–∏–∏ –∑–∞—â–∏—â–∞—é—Ç –æ—Ç –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö)
- üü° Token restore - –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ SQLite (–Ω–æ —ç—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏)

---

## ‚úÖ –§–ò–ù–ê–õ–¨–ù–´–ô –í–ï–†–î–ò–ö–¢

**–î–û–ö–ê–ó–ê–ù–û:** –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã —Å —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–º–∏ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞–º–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏.

**–î–û–ö–ê–ó–ê–ù–û:** –í—Å–µ –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã –∏–∑ –∞—É–¥–∏—Ç–∞ –ª–∏–±–æ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã, –ª–∏–±–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã.

**–î–û–ö–ê–ó–ê–ù–û:** –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ production —Å –æ—Ü–µ–Ω–∫–æ–π 85/100.

**–û–¢–í–ï–¢ –ù–ê –í–û–ü–†–û–°:** ‚úÖ **–î–ê, —Ä–∞–±–æ—Ç–∞ –≤—Å–µ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –¥–æ–∫–∞–∑–∞–Ω–∞.**

---

**Audit Completed:** 2025-01-12  
**All Fixes Applied:** ‚úÖ  
**All Tests Passing:** ‚úÖ  
**Proof Status:** ‚úÖ All critical functionality proven correct
