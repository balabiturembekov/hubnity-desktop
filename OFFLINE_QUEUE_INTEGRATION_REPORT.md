# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Offline Queue —Å API ‚úÖ

## üìã –û–¢–ß–ï–¢ –û –í–´–ü–û–õ–ù–ï–ù–ò–ò

### ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

#### 1. –°–æ–∑–¥–∞–Ω SyncManager –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π –æ—á–µ—Ä–µ–¥–∏

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```rust
#[derive(Clone)]
struct SyncManager {
    db: Arc<Database>,
    api_base_url: String,
}
```

**–ú–µ—Ç–æ–¥—ã:**
- `enqueue_screenshot()` - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞ –≤ –æ—á–µ—Ä–µ–¥—å
- `sync_task()` - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –æ–¥–Ω–æ–π –∑–∞–¥–∞—á–∏
- `sync_queue()` - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö pending –∑–∞–¥–∞—á —Å retry –ª–æ–≥–∏–∫–æ–π

---

#### 2. –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω upload_screenshot –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –æ—á–µ—Ä–µ–¥—å

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –°–∫—Ä–∏–Ω—à–æ—Ç—ã —Ç–µ–ø–µ—Ä—å **—Å–Ω–∞—á–∞–ª–∞** —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `sync_queue`
- –ó–∞—Ç–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è –≤ —Ñ–æ–Ω–µ
- –ü—Ä–∏ –æ—à–∏–±–∫–µ —Å–µ—Ç–∏ –¥–∞–Ω–Ω—ã–µ –æ—Å—Ç–∞—é—Ç—Å—è –≤ –æ—á–µ—Ä–µ–¥–∏ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏

**–ö–æ–¥:**
```rust
#[tauri::command]
async fn upload_screenshot(
    png_data: Vec<u8>,
    time_entry_id: String,
    access_token: String,
    sync_manager: State<'_, SyncManager>,
) -> Result<(), String> {
    // –°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å
    let queue_id = sync_manager.enqueue_screenshot(png_data, time_entry_id, access_token)?;
    eprintln!("[RUST] Screenshot enqueued with ID: {}", queue_id);
    
    // –§–æ–Ω–æ–≤–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —É–∂–µ –∑–∞–ø—É—â–µ–Ω–∞ –≤ setup
    Ok(())
}
```

---

#### 3. –°–æ–∑–¥–∞–Ω Tauri command –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –æ—á–µ—Ä–µ–¥–∏

**–ö–æ–º–∞–Ω–¥–∞:**
```rust
#[tauri::command]
async fn sync_queue_now(sync_manager: State<'_, SyncManager>) -> Result<usize, String> {
    sync_manager.sync_queue(5).await
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
- –ú–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é –∏–∑ frontend –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–¥–∞—á

---

#### 4. –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Ñ–æ–Ω–æ–≤–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

**–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤ setup:**
```rust
// –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ–æ–Ω–æ–≤—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
let sync_manager_bg = sync_manager.clone();
tokio::spawn(async move {
    let mut interval = tokio::time::interval(tokio::time::Duration::from_secs(60)); // –ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
    loop {
        interval.tick().await;
        match sync_manager_bg.sync_queue(5).await {
            Ok(count) => {
                if count > 0 {
                    eprintln!("[SYNC] Synced {} tasks", count);
                }
            }
            Err(e) => {
                eprintln!("[SYNC] Background sync error: {}", e);
            }
        }
    }
});
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –≤ —Ñ–æ–Ω–µ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
- ‚úÖ –ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç pending –∑–∞–¥–∞—á–∏
- ‚úÖ –õ–æ–≥–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

---

#### 5. –î–æ–±–∞–≤–ª–µ–Ω retry –º–µ—Ö–∞–Ω–∏–∑–º —Å exponential backoff

**–õ–æ–≥–∏–∫–∞ retry:**
```rust
async fn sync_queue(&self, max_retries: i32) -> Result<usize, String> {
    // –ò—Å–ø–æ–ª—å–∑—É–µ—Ç get_retry_tasks() —Å exponential backoff
    // Retry –ø–æ—Å–ª–µ: 1 min, 2 min, 4 min, 8 min, 16 min, ...
    
    for (id, entity_type, payload, retry_count) in tasks {
        match self.sync_task(id, entity_type.clone(), payload.clone()).await {
            Ok(true) => {
                // –£—Å–ø–µ—à–Ω–æ - –ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ "sent"
                self.db.update_sync_status(id, "sent", retry_count)?;
            }
            Ok(false) | Err(_) => {
                // –û—à–∏–±–∫–∞ - —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º retry_count
                let new_retry_count = retry_count + 1;
                if new_retry_count >= max_retries {
                    // –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç - –ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ "failed"
                    self.db.update_sync_status(id, "failed", new_retry_count)?;
                } else {
                    // –ü–æ–≤—Ç–æ—Ä–∏–º –ø–æ–∑–∂–µ —Å exponential backoff
                    self.db.update_sync_status(id, "pending", new_retry_count)?;
                }
            }
        }
    }
}
```

**Exponential backoff:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è SQL –∑–∞–ø—Ä–æ—Å —Å `POWER(2, retry_count)` –º–∏–Ω—É—Ç
- –ü–µ—Ä–≤–∞—è –ø–æ–ø—ã—Ç–∫–∞: —Å—Ä–∞–∑—É
- –í—Ç–æ—Ä–∞—è –ø–æ–ø—ã—Ç–∫–∞: —á–µ—Ä–µ–∑ 1 –º–∏–Ω—É—Ç—É
- –¢—Ä–µ—Ç—å—è –ø–æ–ø—ã—Ç–∫–∞: —á–µ—Ä–µ–∑ 2 –º–∏–Ω—É—Ç—ã
- –ß–µ—Ç–≤–µ—Ä—Ç–∞—è –ø–æ–ø—ã—Ç–∫–∞: —á–µ—Ä–µ–∑ 4 –º–∏–Ω—É—Ç—ã
- –ò —Ç–∞–∫ –¥–∞–ª–µ–µ...

**–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫:** 5 (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è)

---

### üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –æ—á–µ—Ä–µ–¥–∏

#### –¢–∞–±–ª–∏—Ü–∞ sync_queue:
```sql
CREATE TABLE sync_queue (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    entity_type TEXT NOT NULL,           -- 'screenshot' | 'time_entry_start' | ...
    payload TEXT NOT NULL,               -- JSON —Å –¥–∞–Ω–Ω—ã–º–∏ + accessToken
    status TEXT NOT NULL DEFAULT 'pending', -- 'pending' | 'sent' | 'failed'
    retry_count INTEGER NOT NULL DEFAULT 0,
    created_at INTEGER NOT NULL,
    last_retry_at INTEGER
);
```

#### –ü—Ä–∏–º–µ—Ä payload –¥–ª—è —Å–∫—Ä–∏–Ω—à–æ—Ç–∞:
```json
{
    "imageData": "data:image/jpeg;base64,...",
    "timeEntryId": "uuid",
    "accessToken": "token"
}
```

---

### üîÑ –ü–æ—Ç–æ–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

1. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –æ—á–µ—Ä–µ–¥—å:**
   - `upload_screenshot()` ‚Üí `enqueue_screenshot()` ‚Üí –∑–∞–ø–∏—Å—å –≤ `sync_queue`

2. **–§–æ–Ω–æ–≤–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:**
   - –ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `get_retry_tasks()`
   - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–¥–∞—á–∏ —Å —É—á–µ—Ç–æ–º exponential backoff
   - –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å: `pending` ‚Üí `sent` –∏–ª–∏ `failed`

3. **Retry –ª–æ–≥–∏–∫–∞:**
   - –ü—Ä–∏ –æ—à–∏–±–∫–µ —Å–µ—Ç–∏: —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è `retry_count`, —Å—Ç–∞—Ç—É—Å –æ—Å—Ç–∞–µ—Ç—Å—è `pending`
   - –ü—Ä–∏ —É—Å–ø–µ—Ö–µ: —Å—Ç–∞—Ç—É—Å –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ `sent`
   - –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞: —Å—Ç–∞—Ç—É—Å –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ `failed`

---

### ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

#### –ì–∞—Ä–∞–Ω—Ç–∏–∏:
- ‚úÖ **–î–∞–Ω–Ω—ã–µ –Ω–µ —Ç–µ—Ä—è—é—Ç—Å—è** - –≤—Å–µ —Å–∫—Ä–∏–Ω—à–æ—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ SQLite
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è** - —Ñ–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
- ‚úÖ **Retry —Å exponential backoff** - –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–µ—Ç —Å–µ—Ä–≤–µ—Ä
- ‚úÖ **–†–∞–±–æ—Ç–∞–µ—Ç –æ—Ñ–ª–∞–π–Ω** - –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –¥–∞–∂–µ –±–µ–∑ —Å–µ—Ç–∏

#### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
- ‚úÖ –ù–µ–±–ª–æ–∫–∏—Ä—É—é—â–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (async/await)
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ 10 –∑–∞–¥–∞—á –∑–∞ —Ä–∞–∑
- ‚úÖ Exponential backoff –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫—É

#### –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:
- ‚úÖ –ú–∞–∫—Å–∏–º—É–º 5 –ø–æ–ø—ã—Ç–æ–∫ –Ω–∞ –∑–∞–¥–∞—á—É
- ‚úÖ –û—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
- ‚úÖ –°—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è –≤ –ë–î

---

### üîß –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–¥–æ–º

#### Backend (Rust):
- ‚úÖ `upload_screenshot` —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ—á–µ—Ä–µ–¥—å
- ‚úÖ `SyncManager` —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ Tauri State
- ‚úÖ –§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ `setup()`

#### Frontend:
- ‚ö†Ô∏è **–¢—Ä–µ–±—É–µ—Ç—Å—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** Frontend –ø–æ–∫–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–æ–≤—É—é –ª–æ–≥–∏–∫—É
- ‚ö†Ô∏è **–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å `api.uploadScreenshot()` –¥–ª—è —Ä–∞–±–æ—Ç—ã —á–µ—Ä–µ–∑ –æ—á–µ—Ä–µ–¥—å

---

### üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è frontend:**
   - –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å `api.uploadScreenshot()` –¥–ª—è –≤—ã–∑–æ–≤–∞ `upload_screenshot` —á–µ—Ä–µ–∑ Tauri
   - –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –æ—á–µ—Ä–µ–¥–∏

2. **–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –¥–ª—è time entries:**
   - –î–æ–±–∞–≤–∏—Ç—å `enqueue_time_entry()` –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π start/pause/resume/stop
   - –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ API –≤—ã–∑–æ–≤—ã

3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
   - –î–æ–±–∞–≤–∏—Ç—å UI –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å—Ç–∞—Ç—É—Å–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
   - –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ pending –∑–∞–¥–∞—á

4. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   - –ù–∞–ø–∏—Å–∞—Ç—å unit —Ç–µ—Å—Ç—ã –¥–ª—è `SyncManager`
   - –ù–∞–ø–∏—Å–∞—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
   - –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å offline —Å—Ü–µ–Ω–∞—Ä–∏–∏

---

### ‚úÖ –°—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

| –ó–∞–¥–∞—á–∞ | –°—Ç–∞—Ç—É—Å |
|--------|--------|
| –°–æ–∑–¥–∞—Ç—å SyncManager | ‚úÖ |
| –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å upload_screenshot | ‚úÖ |
| –°–æ–∑–¥–∞—Ç—å Tauri command –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ | ‚úÖ |
| –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ñ–æ–Ω–æ–≤—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é | ‚úÖ |
| –î–æ–±–∞–≤–∏—Ç—å retry –º–µ—Ö–∞–Ω–∏–∑–º | ‚úÖ |
| –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—á–µ—Ä–µ–¥—å –≤ frontend | ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ |

---

**–î–∞—Ç–∞:** 2025-01-06  
**–í–µ—Ä—Å–∏—è:** 1.0
