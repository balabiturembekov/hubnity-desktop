# –≠–¢–ê–ü 4 ‚Äî SYSTEM SLEEP / WAKE HANDLING ‚úÖ

## üìã –û–¢–ß–ï–¢ –û –í–´–ü–û–õ–ù–ï–ù–ò–ò

### 1. –ö–∞–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è sleep

#### –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ sleep:
- **–ú–µ—Ç–æ–¥:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–æ–ª—å—à–∏—Ö –ø—Ä–æ–ø—É—Å–∫–æ–≤ –≤—Ä–µ–º–µ–Ω–∏ –≤ `get_state()`
- **–ü–æ—Ä–æ–≥:** –ü—Ä–æ–ø—É—Å–∫ > 5 –º–∏–Ω—É—Ç (`SLEEP_DETECTION_THRESHOLD_SECONDS = 300`)
- **–õ–æ–≥–∏–∫–∞:** –ï—Å–ª–∏ `session_elapsed > 5 –º–∏–Ω—É—Ç` ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `handle_system_sleep()`

#### –û–±—Ä–∞–±–æ—Ç–∫–∞ sleep:
```rust
fn handle_system_sleep(&self) -> Result<(), String> {
    let state = self.state.lock()?;
    
    match &*state {
        TimerState::Running { .. } => {
            // –î–æ–ø—É—Å—Ç–∏–º—ã–π –ø–µ—Ä–µ—Ö–æ–¥: Running ‚Üí Paused (–∏–∑-–∑–∞ sleep)
            drop(state);
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ç–æ–¥ pause() –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞ FSM
            // pause() –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
            // 1. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—Ä–µ–º—è —Å–µ—Å—Å–∏–∏ –≤ accumulated
            // 2. –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ Paused
            // 3. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –ë–î
            self.pause()?;
            
            Ok(())
        }
        TimerState::Paused | TimerState::Stopped => {
            // –£–∂–µ –Ω–∞ –ø–∞—É–∑–µ –∏–ª–∏ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω - –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ)
            Ok(())
        }
    }
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –í—Ä–µ–º—è –¥–æ sleep —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `accumulated_seconds`
- ‚úÖ –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ `Paused`
- ‚úÖ –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ SQLite
- ‚úÖ –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ: –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –≤—ã–∑–æ–≤—ã –Ω–µ –º–µ–Ω—è—é—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ

---

### 2. –ö–∞–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è wake

#### –û–±—Ä–∞–±–æ—Ç–∫–∞ wake:
```rust
fn handle_system_wake(&self) -> Result<(), String> {
    eprintln!("[WAKE] System wake detected");
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    let state = self.state.lock()?;
    let state_str = match &*state {
        TimerState::Running { .. } => "running",
        TimerState::Paused => "paused",
        TimerState::Stopped => "stopped",
    };
    drop(state);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º last_updated_at –≤ –ë–î
    // –ù–ï –≤–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º RUNNING –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ - –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ –æ—Å—Ç–∞–≤–∏—Ç—å PAUSED
    self.save_state()?;
    
    Ok(())
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ù–ï –≤–æ–∑–æ–±–Ω–æ–≤–ª—è–µ—Ç `RUNNING` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ –û—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ `PAUSED` (–±–µ–∑–æ–ø–∞—Å–Ω–µ–µ)
- ‚úÖ –û–±–Ω–æ–≤–ª—è–µ—Ç `last_updated_at` –≤ –ë–î
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≤–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é

---

### 3. –ö–∞–∫–∏–µ —Ñ–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã

#### ‚úÖ `src-tauri/src/lib.rs`

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
1. –ú–µ—Ç–æ–¥ `handle_system_sleep()` ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ sleep —Å–æ–±—ã—Ç–∏—è
2. –ú–µ—Ç–æ–¥ `handle_system_wake()` ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ wake —Å–æ–±—ã—Ç–∏—è
3. –ü—Ä–æ–≤–µ—Ä–∫–∞ sleep –≤ `get_state()` ‚Äî –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –±–æ–ª—å—à–∏—Ö –ø—Ä–æ–ø—É—Å–∫–æ–≤ –≤—Ä–µ–º–µ–Ω–∏
4. –§—É–Ω–∫—Ü–∏—è `setup_sleep_wake_handlers()` ‚Äî –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (–ø–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç time-based detection)

**–ò–∑–º–µ–Ω–µ–Ω–æ:**
1. `get_state()` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –±–æ–ª—å—à–∏–µ –ø—Ä–æ–ø—É—Å–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ (> 5 –º–∏–Ω—É—Ç)
2. `run()` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω –≤—ã–∑–æ–≤ `setup_sleep_wake_handlers()` –≤ setup hook

---

### 4. –ö–ª—é—á–µ–≤—ã–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã –∫–æ–¥–∞

#### Sleep detection –≤ get_state():
```rust
fn get_state(&self) -> Result<TimerStateResponse, String> {
    let state = self.state.lock()?;
    let accumulated = *self.accumulated_seconds.lock()?;
    
    let (elapsed_seconds, session_start, needs_sleep_handling) = match &*state {
        TimerState::Running { started_at, started_at_instant } => {
            let now = Instant::now();
            let session_elapsed = now.duration_since(*started_at_instant).as_secs();
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ sleep: –ø—Ä–æ–ø—É—Å–∫ > 5 –º–∏–Ω—É—Ç
            const SLEEP_DETECTION_THRESHOLD_SECONDS: u64 = 5 * 60;
            let is_sleep = session_elapsed > SLEEP_DETECTION_THRESHOLD_SECONDS;
            
            (accumulated + session_elapsed, Some(*started_at), is_sleep)
        }
        TimerState::Paused | TimerState::Stopped => {
            (accumulated, None, false)
        }
    };
    
    // –ï—Å–ª–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω sleep, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –µ–≥–æ
    if needs_sleep_handling {
        drop(state);
        eprintln!("[SLEEP DETECTION] Large time gap detected, auto-pausing");
        self.handle_system_sleep()?;
        // –ü–æ—Å–ª–µ –ø–∞—É–∑—ã –ø–æ–ª—É—á–∞–µ–º –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ
        return self.get_state();
    }
    
    // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ ...
}
```

#### –û–±—Ä–∞–±–æ—Ç–∫–∞ sleep —á–µ—Ä–µ–∑ FSM:
```rust
fn handle_system_sleep(&self) -> Result<(), String> {
    let state = self.state.lock()?;
    
    match &*state {
        TimerState::Running { .. } => {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ç–æ–¥ pause() –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞ FSM
            // –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç:
            // 1. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ Running ‚Üí Paused
            // 2. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤ accumulated
            // 3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ –ë–î
            drop(state);
            self.pause()?;
            Ok(())
        }
        TimerState::Paused | TimerState::Stopped => {
            // –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ: –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –≤—ã–∑–æ–≤—ã –Ω–µ –º–µ–Ω—è—é—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            Ok(())
        }
    }
}
```

#### –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤ setup:
```rust
.setup(|app| {
    // ... –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î ...
    
    let engine = TimerEngine::with_db(db);
    let engine_arc = Arc::new(engine);
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ sleep/wake
    setup_sleep_wake_handlers(app.handle(), engine_arc.clone())?;
    
    let engine_for_manage = Arc::try_unwrap(engine_arc)
        .expect("Engine should not be referenced elsewhere");
    
    app.manage(engine_for_manage);
    Ok(())
})
```

---

## ‚úÖ –†–ï–ó–£–õ–¨–¢–ê–¢

### –°–æ–Ω —Å–∏—Å—Ç–µ–º—ã –ù–ï –∑–∞—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ —Ä–∞–±–æ—Ç–∞
- ‚úÖ –ü—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ sleep (> 5 –º–∏–Ω—É—Ç) —Ç–∞–π–º–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–∞—É–∑–∏—Ç—Å—è
- ‚úÖ –í—Ä–µ–º—è –¥–æ sleep —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `accumulated_seconds`
- ‚úÖ –í—Ä–µ–º—è sleep –Ω–µ –∑–∞—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è

### –¢–∞–π–º–µ—Ä –ø–æ—Å–ª–µ wake –≤—Å–µ–≥–¥–∞ –±–µ–∑–æ–ø–∞—Å–µ–Ω
- ‚úÖ –ü–æ—Å–ª–µ wake —Ç–∞–π–º–µ—Ä –æ—Å—Ç–∞–µ—Ç—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ `PAUSED`
- ‚úÖ –ù–ï –≤–æ–∑–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≤–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é

### –°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ
- ‚úÖ –ü—Ä–∏ sleep —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ SQLite —á–µ—Ä–µ–∑ `pause()`
- ‚úÖ –ü—Ä–∏ wake —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ SQLite —á–µ—Ä–µ–∑ `save_state()`
- ‚úÖ –í—Å–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ FSM

### –ù–∏–∫–∞–∫–∏—Ö time-jump –±–∞–≥–æ–≤
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `Instant::now()` –¥–ª—è –º–æ–Ω–æ—Ç–æ–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
- ‚úÖ –ë–æ–ª—å—à–∏–µ –ø—Ä–æ–ø—É—Å–∫–∏ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞—é—Ç—Å—è –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è
- ‚úÖ –°–æ—Å—Ç–æ—è–Ω–∏–µ –≤—Å–µ–≥–¥–∞ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ

---

## üîÑ –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–´–ï –†–ï–®–ï–ù–ò–Ø

### –ü–æ—á–µ–º—É time-based detection –≤–º–µ—Å—Ç–æ NSWorkspace notifications?

1. **–ü—Ä–æ—Å—Ç–æ—Ç–∞:** –ù–µ —Ç—Ä–µ–±—É–µ—Ç —Å–ª–æ–∂–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å Objective-C –±–ª–æ–∫–∞–º–∏ —á–µ—Ä–µ–∑ FFI
2. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:** –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –≤—Å–µ—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Ö –æ–¥–∏–Ω–∞–∫–æ–≤–æ
3. **–¢–æ—á–Ω–æ—Å—Ç—å:** `Instant` –º–æ–Ω–æ—Ç–æ–Ω–Ω–æ, –ø–æ—ç—Ç–æ–º—É –ø—Ä–æ–ø—É—Å–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –≤—Å–µ–≥–¥–∞ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞—é—Ç—Å—è
4. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –∫–∞–∂–¥–æ–º `get_state()`, —á—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É

### –ü–æ—á–µ–º—É –Ω–µ –≤–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ wake?

1. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥ –Ω–µ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–∞–±–æ—Ç–µ
2. **–ö–æ–Ω—Ç—Ä–æ–ª—å:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º —Ä–µ—à–∞–µ—Ç, –∫–æ–≥–¥–∞ –≤–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å
3. **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å:** –°–æ—Å—Ç–æ—è–Ω–∏–µ `PAUSED` —è–≤–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ —Ç–∞–π–º–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω

### –ü–æ—á–µ–º—É –∏—Å–ø–æ–ª—å–∑—É–µ–º pause() –≤–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è?

1. **FSM:** –í—Å–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –¥–æ–ª–∂–Ω—ã –ø—Ä–æ—Ö–æ–¥–∏—Ç—å —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã FSM
2. **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å:** `pause()` –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
3. **–ë–î:** `pause()` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ SQLite

---

## üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê

- **–î–æ–±–∞–≤–ª–µ–Ω–æ –º–µ—Ç–æ–¥–æ–≤:** 2 (`handle_system_sleep`, `handle_system_wake`)
- **–ò–∑–º–µ–Ω–µ–Ω–æ –º–µ—Ç–æ–¥–æ–≤:** 1 (`get_state` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ sleep)
- **–ü–æ—Ä–æ–≥ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è:** 5 –º–∏–Ω—É—Ç
- **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å:** ‚úÖ –í—Å–µ –º–µ—Ç–æ–¥—ã –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã

---

## ‚úÖ –≠–¢–ê–ü 4 –ó–ê–í–ï–†–®–ï–ù

**Sleep/Wake handling —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω:**
- ‚úÖ Sleep –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫—É –≤—Ä–µ–º–µ–Ω–∏
- ‚úÖ Sleep –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ FSM (pause())
- ‚úÖ Wake –Ω–µ –≤–æ–∑–æ–±–Ω–æ–≤–ª—è–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ –°–æ—Å—Ç–æ—è–Ω–∏–µ –≤—Å–µ–≥–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î
- ‚úÖ –ù–∏–∫–∞–∫–∏—Ö time-jump –±–∞–≥–æ–≤

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –≠–¢–ê–ü 5 ‚Äî ACTIVE WINDOW TRACKING (MINIMUM)
