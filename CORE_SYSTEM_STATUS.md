# –°—Ç–∞—Ç—É—Å —è–¥—Ä–∞ —Å–∏—Å—Ç–µ–º—ã –∏ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏

**–î–∞—Ç–∞:** 2024-12-19  
**–§–æ–∫—É—Å:** –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —è–¥—Ä–∞ —Å–∏—Å—Ç–µ–º—ã –∏ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏

---

## ‚úÖ –Ø–î–†–û –°–ò–°–¢–ï–ú–´ - –¢–ï–ö–£–©–ò–ô –°–¢–ê–¢–£–°

### 1. TimerEngine (Rust) ‚úÖ **100% –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏**

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **Production-ready**

**–ü–æ–∫—Ä—ã—Ç–∏–µ:**
- ‚úÖ 32 unit —Ç–µ—Å—Ç–∞
- ‚úÖ –í—Å–µ FSM –ø–µ—Ä–µ—Ö–æ–¥—ã –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã
- ‚úÖ –í—Å–µ edge cases –ø–æ–∫—Ä—ã—Ç—ã
- ‚úÖ Runtime guards —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞—â–∏—Ç—ã:**
- ‚úÖ Overflow protection (`saturating_add`)
- ‚úÖ Clock skew detection (—Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ SystemTime –∏ Instant)
- ‚úÖ Timezone UTC fix (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ UTC –¥–ª—è day boundaries)
- ‚úÖ SQLite transactional safety (`BEGIN IMMEDIATE`/`COMMIT`/`ROLLBACK`)
- ‚úÖ Rollover idempotency (–∑–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ rollover)
- ‚úÖ Recursive `get_state()` protection (MAX_RECURSION_DEPTH = 3)
- ‚úÖ Sleep detection threshold (15 –º–∏–Ω—É—Ç, —Ç–æ–ª—å–∫–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)

**–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞:**
- ‚úÖ –°—Ç—Ä–æ–≥–∞—è FSM (Stopped ‚Üí Running ‚Üí Paused ‚Üí Stopped)
- ‚úÖ –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ (`accumulated_seconds`)
- ‚úÖ Day rollover (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±—Ä–æ—Å –≤ –ø–æ–ª–Ω–æ—á—å)
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ –ë–î –ø—Ä–∏ –∫–∞–∂–¥–æ–º –ø–µ—Ä–µ—Ö–æ–¥–µ
- ‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞

---

### 2. Database (SQLite) ‚ö†Ô∏è **~85% –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏**

**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è **–•–æ—Ä–æ—à–æ, –Ω–æ –µ—Å—Ç—å –ø—Ä–æ–±–µ–ª—ã**

**–ü–æ–∫—Ä—ã—Ç–æ:**
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–∑–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ç–∞–π–º–µ—Ä–∞
- ‚úÖ Sync queue –æ–ø–µ—Ä–∞—Ü–∏–∏ (enqueue, get_pending, update_status)
- ‚úÖ Retry tasks
- ‚úÖ –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –¥–Ω–∏

**–ù–µ –ø–æ–∫—Ä—ã—Ç–æ:**
- ‚ùå –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (BEGIN IMMEDIATE/COMMIT/ROLLBACK) - —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ, –Ω–æ –Ω–µ—Ç —Ç–µ—Å—Ç–æ–≤
- ‚ùå WAL mode –∏ foreign keys - —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ, –Ω–æ –Ω–µ—Ç —Ç–µ—Å—Ç–æ–≤
- ‚ùå –û–±—Ä–∞–±–æ—Ç–∫–∞ corrupted –ë–î - –Ω–µ—Ç —Ç–µ—Å—Ç–æ–≤
- ‚ùå Partial write scenarios - –Ω–µ—Ç —Ç–µ—Å—Ç–æ–≤

**–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞:**
- ‚úÖ –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ç–∞–π–º–µ—Ä–∞
- ‚úÖ Offline queue –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- ‚úÖ Retry –º–µ—Ö–∞–Ω–∏–∑–º —Å exponential backoff
- ‚ö†Ô∏è –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã, –Ω–æ –Ω–µ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã

---

### 3. SyncManager ‚ö†Ô∏è **~40% –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏**

**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è **–ë–∞–∑–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ–∫—Ä—ã—Ç—ã, –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ª–æ–≥–∏–∫–∞ –Ω–µ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞**

**–ü–æ–∫—Ä—ã—Ç–æ:**
- ‚úÖ `enqueue_time_entry()` - –±–∞–∑–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- ‚úÖ –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
- ‚úÖ –†–∞–∑–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (start, pause, resume, stop)

**–ù–µ –ø–æ–∫—Ä—ã—Ç–æ (—Ç—Ä–µ–±—É—é—Ç HTTP –º–æ–∫–æ–≤):**
- ‚ùå `sync_queue()` - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –æ—á–µ—Ä–µ–¥–∏
- ‚ùå `refresh_token()` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
- ‚ùå Retry –º–µ—Ö–∞–Ω–∏–∑–º —Å exponential backoff
- ‚ùå –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–æ–∫
- ‚ùå –û–±—Ä–∞–±–æ—Ç–∫–∞ 401 –æ—à–∏–±–æ–∫

**–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞:**
- ‚úÖ Offline-first –ø–æ–¥—Ö–æ–¥ (–¥–∞–Ω–Ω—ã–µ —Å–Ω–∞—á–∞–ª–∞ –≤ –ë–î)
- ‚úÖ –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –≤ –ë–î
- ‚úÖ Retry —Å exponential backoff (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ, –Ω–æ –Ω–µ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ)
- ‚ö†Ô∏è Token refresh –ø—Ä–∏ 401 (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ, –Ω–æ –Ω–µ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ)

---

## üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´ –ë–ò–ó–ù–ï–°-–õ–û–ì–ò–ö–ò

### 1. Database - —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –Ω–µ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞

**–ü—Ä–æ–±–ª–µ–º–∞:** –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã (`BEGIN IMMEDIATE`/`COMMIT`/`ROLLBACK`), –Ω–æ –Ω–µ—Ç unit —Ç–µ—Å—Ç–æ–≤.

**–†–∏—Å–∫:** –ü—Ä–∏ –∫—Ä–∞—à–µ –≤–æ –≤—Ä–µ–º—è –∑–∞–ø–∏—Å–∏ –º–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏ corruption –ë–î.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å unit —Ç–µ—Å—Ç—ã –¥–ª—è:
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø—Ä–∏ `save_timer_state()`
- Rollback –ø—Ä–∏ –æ—à–∏–±–∫–µ
- WAL mode –ø—Ä–æ–≤–µ—Ä–∫–∞

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ **HIGH**

---

### 2. SyncManager - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ª–æ–≥–∏–∫–∞ –Ω–µ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞

**–ü—Ä–æ–±–ª–µ–º–∞:** Retry –º–µ—Ö–∞–Ω–∏–∑–º –∏ token refresh —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã, –Ω–æ –Ω–µ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã.

**–†–∏—Å–∫:** –ü—Ä–∏ —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–∫–∞—Ö –¥–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –ø–æ—Ç–µ—Ä—è—Ç—å—Å—è –∏–ª–∏ –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å unit —Ç–µ—Å—Ç—ã —Å HTTP –º–æ–∫–∞–º–∏ –¥–ª—è:
- Retry —Å exponential backoff
- Token refresh –ø—Ä–∏ 401
- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–æ–∫

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ **HIGH**

---

### 3. Edge cases –Ω–µ –ø–æ–∫—Ä—ã—Ç—ã —Ç–µ—Å—Ç–∞–º–∏

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ–∫–æ—Ç–æ—Ä—ã–µ edge cases –∏–∑ –∞—É–¥–∏—Ç–∞ –Ω–µ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã:
- –û—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏ (> 100 –¥–Ω–µ–π)
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –≤–æ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ timezone –≤–æ –≤—Ä–µ–º—è RUNNING
- Corrupted SQLite –ë–î
- Partial write –ø—Ä–∏ –∫—Ä–∞—à–µ

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å unit —Ç–µ—Å—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ edge case.

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** ‚ö†Ô∏è **MEDIUM**

---

## ‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–ù–´–ï –ó–ê–©–ò–¢–´ (–∏–∑ –∞—É–¥–∏—Ç–∞)

### 1. Clock Skew Detection ‚úÖ
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ `rollover_day()`
- –õ–æ–≥–∏—Ä—É–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–∏ > 60 —Å–µ–∫—É–Ω–¥
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `Instant` –∫–∞–∫ source of truth

### 2. Timezone UTC Fix ‚úÖ
- –í—Å–µ day boundaries –∏—Å–ø–æ–ª—å–∑—É—é—Ç UTC
- `ensure_correct_day()` —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç UTC –¥–∞—Ç—ã
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ timezone –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç –ª–æ–∂–Ω—ã—Ö rollover'–æ–≤

### 3. SQLite Transactional Safety ‚úÖ
- `save_state()` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- WAL mode –≤–∫–ª—é—á–µ–Ω
- Foreign keys –≤–∫–ª—é—á–µ–Ω—ã

### 4. Rollover Idempotency ‚úÖ
- –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ rollover
- –ü—Ä–æ–≤–µ—Ä–∫–∞ `day_start_timestamp` –ø–µ—Ä–µ–¥ rollover
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

### 5. Recursive `get_state()` Protection ‚úÖ
- MAX_RECURSION_DEPTH = 3
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
- –í–æ–∑–≤—Ä–∞—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è

---

## üéØ –ü–†–ò–û–†–ò–¢–ï–¢–´ –î–õ–Ø –£–õ–£–ß–®–ï–ù–ò–Ø –Ø–î–†–ê

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1 (–ö—Ä–∏—Ç–∏—á–Ω–æ):
1. ‚úÖ **TimerEngine** - 100% –ø–æ–∫—Ä—ã—Ç–∏–µ (–∑–∞–≤–µ—Ä—à–µ–Ω–æ)
2. ‚è≥ **Database** - –¥–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
3. ‚è≥ **SyncManager** - –¥–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è retry –∏ token refresh

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2 (–í–∞–∂–Ω–æ):
4. ‚è≥ **Edge cases** - –¥–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö —Å–µ—Å—Å–∏–π, –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏, corrupted –ë–î

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3 (–ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ):
5. ‚è≥ **ActivityMonitor** - –¥–æ–±–∞–≤–∏—Ç—å unit —Ç–µ—Å—Ç—ã
6. ‚è≥ **Sleep/Wake handlers** - –¥–æ–±–∞–≤–∏—Ç—å unit —Ç–µ—Å—Ç—ã

---

## üìä –û–ë–©–ê–Ø –û–¶–ï–ù–ö–ê –Ø–î–†–ê

**TimerEngine:** ‚úÖ **100%** - Production-ready  
**Database:** ‚ö†Ô∏è **85%** - –•–æ—Ä–æ—à–æ, –Ω–æ –Ω—É–∂–Ω—ã —Ç–µ—Å—Ç—ã –¥–ª—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π  
**SyncManager:** ‚ö†Ô∏è **40%** - –ë–∞–∑–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ–∫—Ä—ã—Ç—ã, –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ª–æ–≥–∏–∫–∞ –Ω–µ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞  

**–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ —è–¥—Ä–∞:** ‚ö†Ô∏è **75%** - –•–æ—Ä–æ—à–æ, –Ω–æ –µ—Å—Ç—å –ø—Ä–æ–±–µ–ª—ã –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –ª–æ–≥–∏–∫–µ

---

## üîÑ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

1. **–î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è Database —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π** (1-2 —á–∞—Å–∞)
2. **–î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è SyncManager retry –∏ token refresh** (2-3 —á–∞—Å–∞)
3. **–î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è edge cases** (2-3 —á–∞—Å–∞)

**–ò—Ç–æ–≥–æ:** 5-8 —á–∞—Å–æ–≤ —Ä–∞–±–æ—Ç—ã –¥–ª—è –¥–æ–≤–µ–¥–µ–Ω–∏—è —è–¥—Ä–∞ –¥–æ 100% –ø–æ–∫—Ä—ã—Ç–∏—è —Ç–µ—Å—Ç–∞–º–∏.
