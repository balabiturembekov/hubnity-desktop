# –ü–†–û–ì–†–ï–°–° –ü–ï–†–ï–•–û–î–ê –ö PRODUCTION-GRADE –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò

**–î–∞—Ç–∞:** 2025-01-08  
**–°—Ç–∞—Ç—É—Å:** –í –ø—Ä–æ—Ü–µ—Å—Å–µ

---

## ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û

### –≠—Ç–∞–ø 1: –ë–∞–∑–æ–≤–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (‚úÖ –ó–ê–í–ï–†–®–ï–ù)
1. ‚úÖ –°–æ–∑–¥–∞–Ω AuthManager –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞–º–∏
2. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω sync-lock (AtomicBool + Mutex) –≤ SyncManager
3. ‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏—è
4. ‚úÖ –°–æ–∑–¥–∞–Ω–∞ Tauri –∫–æ–º–∞–Ω–¥–∞ `set_auth_tokens` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ –∏–∑ frontend

### –≠—Ç–∞–ø 2: –£–±—Ä–∞—Ç—å —Ç–æ–∫–µ–Ω—ã –∏–∑ payload (üîÑ –í –ü–†–û–¶–ï–°–°–ï)
1. ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î: –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ `priority`
2. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω `enqueue_time_entry()` - —Ç–æ–∫–µ–Ω—ã –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è
3. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω `enqueue_screenshot()` - —Ç–æ–∫–µ–Ω—ã –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è
4. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω `sync_task()` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç AuthManager
5. ‚è≥ –û–±–Ω–æ–≤–ª–µ–Ω—ã —Ç–µ—Å—Ç—ã (—á–∞—Å—Ç–∏—á–Ω–æ - 3 –∏–∑ ~7 —Ç–µ—Å—Ç–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω—ã)

---

## ‚è≥ –í –ü–†–û–¶–ï–°–°–ï

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤
- `test_enqueue_time_entry_encrypts_tokens` ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω
- `test_sync_task_missing_access_token` ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω
- `test_sync_task_decrypt_token_error` ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω
- –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–µ —Ç–æ–∫–µ–Ω—ã –≤ payload - –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å

---

## üìã –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –ó–∞–≤–µ—Ä—à–∏—Ç—å –≠—Ç–∞–ø 2
1. –û–±–Ω–æ–≤–∏—Ç—å –æ—Å—Ç–∞–≤—à–∏–µ—Å—è —Ç–µ—Å—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ–≤–µ—Ä—è—é—Ç —Ç–æ–∫–µ–Ω—ã –≤ payload
2. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –≠—Ç–∞–ø 3 - –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π batch processing
1. –û–±–Ω–æ–≤–∏—Ç—å `get_retry_tasks()` - –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π LIMIT (10 ‚Üí 50 ‚Üí 100)
2. Partial success –≤ `sync_queue()` - —É–¥–∞–ª—è—Ç—å —É—Å–ø–µ—à–Ω—ã–µ –∑–∞–¥–∞—á–∏ —Å—Ä–∞–∑—É
3. –û—á–∏—Å—Ç–∫–∞ sent –∑–∞–¥–∞—á (—Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π)

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: –≠—Ç–∞–ø 4 - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –∏ –ª–∏–º–∏—Ç—ã
1. –û–±–Ω–æ–≤–∏—Ç—å `get_retry_tasks()` –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É
2. –õ–∏–º–∏—Ç –æ—á–µ—Ä–µ–¥–∏ (10_000) - —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω –≤ `enqueue_sync()`

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 4: –≠—Ç–∞–ø 5 - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è sync-lock
1. –û–±–Ω–æ–≤–∏—Ç—å `sync_queue()` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å lock
2. –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ —Ç–æ—á–∫–∏ –≤—Ö–æ–¥–∞ (sync_queue_now, retry_failed_tasks, background job)

---

## üîß –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –î–ï–¢–ê–õ–ò

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ:
- **AuthManager:** –•—Ä–∞–Ω–∏—Ç —Ç–æ–∫–µ–Ω—ã –≤ `Arc<tokio::sync::RwLock<Option<String>>>`
- **SyncManager:** –î–æ–±–∞–≤–ª–µ–Ω—ã `sync_lock` –∏ `is_syncing` –¥–ª—è single-flight
- **Payload:** –ë–æ–ª—å—à–µ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç `accessToken`, `refreshToken`, `_encrypted`
- **–ë–î:** –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ `priority` (0=Critical, 1=High, 2=Normal)
- **–õ–∏–º–∏—Ç –æ—á–µ—Ä–µ–¥–∏:** 10_000 –∑–∞–¥–∞—á (—Å safe drop –¥–ª—è non-critical)

### –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:
- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã `access_token` –∏ `refresh_token` –≤ `enqueue_time_entry()` –∏ `enqueue_screenshot()` –æ—Å—Ç–∞–≤–ª–µ–Ω—ã –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è
- –°—Ç–∞—Ä—ã–µ –∑–∞–¥–∞—á–∏ –≤ –ë–î –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–∫–µ–Ω—ã –≤ payload - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –æ–Ω–∏ –±—É–¥—É—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã (–Ω–æ —Ç–æ–∫–µ–Ω—ã –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è)

---

**–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 2025-01-08
