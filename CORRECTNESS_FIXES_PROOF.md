# –î–û–ö–ê–ó–ê–¢–ï–õ–¨–°–¢–í–ê –ö–û–†–†–ï–ö–¢–ù–û–°–¢–ò –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô
## Staff+ Backend Engineer / Distributed Systems Correctness Auditor

**Date:** 2025-01-12  
**Status:** –í—Å–µ 5 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∏ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω—ã

---

## ‚úÖ FIX 1: –ê—Ç–æ–º–∞—Ä–Ω—ã–µ –º—É—Ç–∞—Ü–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ç–∞–π–º–µ—Ä–∞

### –ü—Ä–æ–±–ª–µ–º–∞
**–ù–ê–†–£–®–ï–ù–û:** Crash –º–µ–∂–¥—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º `accumulated` –≤ –ø–∞–º—è—Ç–∏ –∏ `save_state()` –ø—Ä–∏–≤–æ–¥–∏–ª –∫ –ø–µ—Ä–µ—Å—á–µ—Ç—É –≤—Ä–µ–º–µ–Ω–∏.

### –†–µ—à–µ–Ω–∏–µ
1. –í—ã—á–∏—Å–ª—è–µ–º `new_accumulated` –ë–ï–ó –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ –ø–∞–º—è—Ç–∏
2. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å `new_accumulated` —á–µ—Ä–µ–∑ `save_state_with_accumulated_override()`
3. –û–±–Ω–æ–≤–ª—è–µ–º `accumulated` –≤ –ø–∞–º—è—Ç–∏ –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è

### –î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏

**–°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–æ—Ä–º–∞–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ**
```
1. pause() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
2. new_accumulated –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è (–Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏)
3. save_state_with_accumulated_override(Some(new_accumulated)) ‚Üí Ok(())
4. accumulated –≤ –ø–∞–º—è—Ç–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
5. –î–û–ö–ê–ó–ê–ù–û: accumulated –≤ –ø–∞–º—è—Ç–∏ = accumulated –≤ –ë–î
```

**–°—Ü–µ–Ω–∞—Ä–∏–π 2: Crash –ø–æ—Å–ª–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è, –¥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è**
```
1. pause() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
2. new_accumulated –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è (–Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏)
3. Process killed
4. accumulated –≤ –ø–∞–º—è—Ç–∏ –ù–ï –∏–∑–º–µ–Ω–µ–Ω
5. –ë–î —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
6. restore_state() –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
7. –î–û–ö–ê–ó–ê–ù–û: –ù–µ—Ç –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö, –Ω–µ—Ç –ø–µ—Ä–µ—Å—á–µ—Ç–∞
```

**–°—Ü–µ–Ω–∞—Ä–∏–π 3: Crash –≤–æ –≤—Ä–µ–º—è save_state()**
```
1. pause() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
2. new_accumulated –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è
3. save_state_with_accumulated_override() –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è
4. Process killed –≤–æ –≤—Ä–µ–º—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
5. SQLite –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é (BEGIN IMMEDIATE –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —ç—Ç–æ)
6. accumulated –≤ –ø–∞–º—è—Ç–∏ –ù–ï –∏–∑–º–µ–Ω–µ–Ω
7. –ë–î —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
8. –î–û–ö–ê–ó–ê–ù–û: –ù–µ—Ç –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö, –Ω–µ—Ç –ø–µ—Ä–µ—Å—á–µ—Ç–∞
```

**–°—Ü–µ–Ω–∞—Ä–∏–π 4: save_state() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É**
```
1. pause() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
2. new_accumulated –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è
3. save_state_with_accumulated_override() ‚Üí Err(e)
4. pause() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç Err(e)
5. accumulated –≤ –ø–∞–º—è—Ç–∏ –ù–ï –∏–∑–º–µ–Ω–µ–Ω
6. –ë–î —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
7. –î–û–ö–ê–ó–ê–ù–û: –ù–µ—Ç –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö, —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ
```

**–í–´–í–û–î:** ‚úÖ **–î–û–ö–ê–ó–ê–ù–û** - –ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞. –õ–∏–±–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç –≤–º–µ—Å—Ç–µ, –ª–∏–±–æ –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç.

---

## ‚úÖ FIX 2: –Ø–≤–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –¥–ª—è enqueue_sync()

### –ü—Ä–æ–±–ª–µ–º–∞
**–ù–ê–†–£–®–ï–ù–û:** Crash –º–µ–∂–¥—É INSERT –∏ auto-commit –ø—Ä–∏–≤–æ–¥–∏–ª –∫ –ø–æ—Ç–µ—Ä–µ –∑–∞–¥–∞—á–∏.

### –†–µ—à–µ–Ω–∏–µ
1. BEGIN IMMEDIATE TRANSACTION –ø–µ—Ä–µ–¥ –≤—Å–µ–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏
2. –í—Å–µ SELECT/INSERT –≤–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
3. COMMIT —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ INSERT
4. ROLLBACK –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ

### –î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏

**–°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–æ—Ä–º–∞–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ**
```
1. BEGIN IMMEDIATE TRANSACTION
2. Duplicate check (SELECT)
3. Queue limit check (SELECT)
4. INSERT INTO sync_queue
5. COMMIT
6. –î–û–ö–ê–ó–ê–ù–û: –ó–∞–¥–∞—á–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ –ë–î
```

**–°—Ü–µ–Ω–∞—Ä–∏–π 2: Crash –ø–æ—Å–ª–µ BEGIN, –¥–æ INSERT**
```
1. BEGIN IMMEDIATE TRANSACTION
2. Process killed
3. SQLite –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
4. –î–û–ö–ê–ó–ê–ù–û: –ó–∞–¥–∞—á–∞ –ù–ï —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞, –Ω–µ—Ç partial state
```

**–°—Ü–µ–Ω–∞—Ä–∏–π 3: Crash –ø–æ—Å–ª–µ INSERT, –¥–æ COMMIT**
```
1. BEGIN IMMEDIATE TRANSACTION
2. INSERT INTO sync_queue
3. Process killed
4. SQLite –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
5. –î–û–ö–ê–ó–ê–ù–û: –ó–∞–¥–∞—á–∞ –ù–ï —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞, –Ω–µ—Ç partial state
```

**–°—Ü–µ–Ω–∞—Ä–∏–π 4: –û—à–∏–±–∫–∞ –≤–æ –≤—Ä–µ–º—è INSERT**
```
1. BEGIN IMMEDIATE TRANSACTION
2. INSERT INTO sync_queue ‚Üí Err(e)
3. ROLLBACK
4. –î–û–ö–ê–ó–ê–ù–û: –ó–∞–¥–∞—á–∞ –ù–ï —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–∫–∞—á–µ–Ω–∞
```

**–í–´–í–û–î:** ‚úÖ **–î–û–ö–ê–ó–ê–ù–û** - –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å. –õ–∏–±–æ –∑–∞–¥–∞—á–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞, –ª–∏–±–æ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤–æ–æ–±—â–µ.

---

## ‚úÖ FIX 3: Retry –¥–ª—è mark_task_sent() –ø—Ä–∏ –æ—à–∏–±–∫–µ

### –ü—Ä–æ–±–ª–µ–º–∞
**–ù–ê–†–£–®–ï–ù–û:** HTTP success + mark_task_sent() failure –ø—Ä–∏–≤–æ–¥–∏–ª –∫ –¥—É–±–ª–∏–∫–∞—Ç–∞–º.

### –†–µ—à–µ–Ω–∏–µ
1. Retry mark_task_sent() —Å exponential backoff (100ms, 200ms, 400ms)
2. –ú–∞–∫—Å–∏–º—É–º 3 –ø–æ–ø—ã—Ç–∫–∏
3. –ï—Å–ª–∏ –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã - –∑–∞–¥–∞—á–∞ –æ—Å—Ç–∞–µ—Ç—Å—è pending (–ª—É—á—à–µ, —á–µ–º –ø–æ—Ç–µ—Ä—è—Ç—å)

### –î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏

**–°—Ü–µ–Ω–∞—Ä–∏–π 1: mark_task_sent() —É—Å–ø–µ—à–µ–Ω —Å –ø–µ—Ä–≤–æ–π –ø–æ–ø—ã—Ç–∫–∏**
```
1. HTTP 200 OK
2. mark_task_sent() ‚Üí Ok(())
3. –ó–∞–¥–∞—á–∞ –ø–æ–º–µ—á–µ–Ω–∞ –∫–∞–∫ sent
4. –î–û–ö–ê–ó–ê–ù–û: –ù–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç–∞
```

**–°—Ü–µ–Ω–∞—Ä–∏–π 2: mark_task_sent() —É—Å–ø–µ—à–µ–Ω —Å–æ –≤—Ç–æ—Ä–æ–π –ø–æ–ø—ã—Ç–∫–∏**
```
1. HTTP 200 OK
2. mark_task_sent() ‚Üí Err(e) (transient DB error)
3. Wait 100ms
4. mark_task_sent() ‚Üí Ok(())
5. –ó–∞–¥–∞—á–∞ –ø–æ–º–µ—á–µ–Ω–∞ –∫–∞–∫ sent
6. –î–û–ö–ê–ó–ê–ù–û: –ù–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç–∞
```

**–°—Ü–µ–Ω–∞—Ä–∏–π 3: –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã**
```
1. HTTP 200 OK
2. mark_task_sent() ‚Üí Err(e) (3 –ø–æ–ø—ã—Ç–∫–∏)
3. –ó–∞–¥–∞—á–∞ –æ—Å—Ç–∞–µ—Ç—Å—è pending
4. –°–ª–µ–¥—É—é—â–∏–π sync –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–Ω–æ–≤–∞
5. –î–û–ö–ê–ó–ê–ù–û: –í–æ–∑–º–æ–∂–µ–Ω –¥—É–±–ª–∏–∫–∞—Ç, –Ω–æ –∑–∞–¥–∞—á–∞ –Ω–µ –ø–æ—Ç–µ—Ä—è–Ω–∞
6. –ü–†–ò–ú–ï–ß–ê–ù–ò–ï: –≠—Ç–æ –ª—É—á—à–µ, —á–µ–º –ø–æ—Ç–µ—Ä—è—Ç—å –∑–∞–¥–∞—á—É, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
```

**–°—Ü–µ–Ω–∞—Ä–∏–π 4: Crash –≤–æ –≤—Ä–µ–º—è retry**
```
1. HTTP 200 OK
2. mark_task_sent() ‚Üí Err(e)
3. Wait 100ms
4. Process killed
5. –ó–∞–¥–∞—á–∞ –æ—Å—Ç–∞–µ—Ç—Å—è pending
6. –°–ª–µ–¥—É—é—â–∏–π sync –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–Ω–æ–≤–∞
7. –î–û–ö–ê–ó–ê–ù–û: –í–æ–∑–º–æ–∂–µ–Ω –¥—É–±–ª–∏–∫–∞—Ç, –Ω–æ –∑–∞–¥–∞—á–∞ –Ω–µ –ø–æ—Ç–µ—Ä—è–Ω–∞
```

**–í–´–í–û–î:** ‚úÖ **–î–û–ö–ê–ó–ê–ù–û** - Retry –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —Å–Ω–∏–∂–∞–µ—Ç –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –¥—É–±–ª–∏–∫–∞—Ç–æ–≤. –í —Ö—É–¥—à–µ–º —Å–ª—É—á–∞–µ (–≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã) –≤–æ–∑–º–æ–∂–µ–Ω –¥—É–±–ª–∏–∫–∞—Ç, –Ω–æ –∑–∞–¥–∞—á–∞ –Ω–µ –ø–æ—Ç–µ—Ä—è–Ω–∞.

**–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø:** –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–ª—É—á–∞–µ–≤, –∫–æ–≥–¥–∞ mark_task_sent() –Ω–µ —É–¥–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫.

---

## ‚úÖ FIX 4: Clock skew detection –≤ restore_state()

### –ü—Ä–æ–±–ª–µ–º–∞
**–ù–ê–†–£–®–ï–ù–û:** Clock adjustment (backward/forward) –ø—Ä–∏–≤–æ–¥–∏–ª –∫ –ø–æ—Ç–µ—Ä–µ/–ø–µ—Ä–µ—Å—á–µ—Ç—É –≤—Ä–µ–º–µ–Ω–∏.

### –†–µ—à–µ–Ω–∏–µ
1. –ü—Ä–æ–≤–µ—Ä–∫–∞ `now < started_at` ‚Üí clock backward
2. –ü—Ä–æ–≤–µ—Ä–∫–∞ `elapsed_since_save > 24 hours` ‚Üí clock forward –∏–ª–∏ —Å–∏—Å—Ç–µ–º–Ω–∞—è –æ—à–∏–±–∫–∞
3. –í –æ–±–æ–∏—Ö —Å–ª—É—á–∞—è—Ö –ù–ï –¥–æ–±–∞–≤–ª—è–µ–º elapsed time

### –î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏

**–°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–æ—Ä–º–∞–ª—å–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ**
```
1. Timer –±—ã–ª running, saved with started_at = T1
2. App restarts at T2 (T2 > T1)
3. elapsed_since_save = T2 - T1 (—Ä–∞–∑—É–º–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ < 24h)
4. final_accumulated = accumulated + elapsed_since_save
5. –î–û–ö–ê–ó–ê–ù–û: –í—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
```

**–°—Ü–µ–Ω–∞—Ä–∏–π 2: Clock backward**
```
1. Timer –±—ã–ª running, saved with started_at = T1
2. Clock adjusted backward to T0 (T0 < T1)
3. App restarts
4. now = T0, started_at = T1
5. now < started_at ‚Üí clock skew detected
6. final_accumulated = accumulated (–ù–ï –¥–æ–±–∞–≤–ª—è–µ–º elapsed)
7. –î–û–ö–ê–ó–ê–ù–û: –í—Ä–µ–º—è –ù–ï –ø–æ—Ç–µ—Ä—è–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è saved accumulated
```

**–°—Ü–µ–Ω–∞—Ä–∏–π 3: Clock forward (–±–æ–ª—å—à–æ–π —Å–∫–∞—á–æ–∫)**
```
1. Timer –±—ã–ª running, saved with started_at = T1
2. Clock adjusted forward to T2 (T2 >> T1, > 24h)
3. App restarts
4. elapsed_since_save = T2 - T1 > 24h
5. elapsed_since_save > MAX_REASONABLE_ELAPSED ‚Üí clock skew detected
6. final_accumulated = accumulated (–ù–ï –¥–æ–±–∞–≤–ª—è–µ–º elapsed)
7. –î–û–ö–ê–ó–ê–ù–û: –í—Ä–µ–º—è –ù–ï –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è saved accumulated
```

**–°—Ü–µ–Ω–∞—Ä–∏–π 4: –ù–æ—Ä–º–∞–ª—å–Ω—ã–π –¥–ª–∏—Ç–µ–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥ (> 24h)**
```
1. Timer –±—ã–ª running, saved with started_at = T1
2. App restarts —á–µ—Ä–µ–∑ 25 —á–∞—Å–æ–≤ (–Ω–æ—Ä–º–∞–ª—å–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π)
3. elapsed_since_save = 25h > 24h
4. elapsed_since_save > MAX_REASONABLE_ELAPSED ‚Üí clock skew detected
5. final_accumulated = accumulated (–ù–ï –¥–æ–±–∞–≤–ª—è–µ–º elapsed)
6. –î–û–ö–ê–ó–ê–ù–û: –í—Ä–µ–º—è –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—É—á—Ç–µ–Ω–æ, –Ω–æ —ç—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ, —á–µ–º –ø–µ—Ä–µ—Å—á–µ—Ç
7. –ü–†–ò–ú–ï–ß–ê–ù–ò–ï: –≠—Ç–æ edge case - –æ–±—ã—á–Ω–æ —Ç–∞–π–º–µ—Ä –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç 25 —á–∞—Å–æ–≤ –ø–æ–¥—Ä—è–¥
```

**–í–´–í–û–î:** ‚úÖ **–î–û–ö–ê–ó–ê–ù–û** - Clock skew detection –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–æ—Ç–µ—Ä—é –∏ –ø–µ—Ä–µ—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏. –í edge case (25+ —á–∞—Å–æ–≤) –≤—Ä–µ–º—è –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—É—á—Ç–µ–Ω–æ, –Ω–æ —ç—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ, —á–µ–º –ø–µ—Ä–µ—Å—á–µ—Ç.

---

## ‚úÖ FIX 5: Idempotency keys –¥–ª—è HTTP –∑–∞–ø—Ä–æ—Å–æ–≤

### –ü—Ä–æ–±–ª–µ–º–∞
**–ù–ê–†–£–®–ï–ù–û:** –î—É–±–ª–∏–∫–∞—Ç—ã HTTP –∑–∞–ø—Ä–æ—Å–æ–≤ —Å–æ–∑–¥–∞–≤–∞–ª–∏ –¥—É–±–ª–∏–∫–∞—Ç—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.

### –†–µ—à–µ–Ω–∏–µ
1. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è idempotency_key –∏–∑ entity_type + payload (hash)
2. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ idempotency_key –≤ –ë–î
3. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ X-Idempotency-Key –∑–∞–≥–æ–ª–æ–≤–∫–∞ –≤ HTTP –∑–∞–ø—Ä–æ—Å—ã
4. –°–µ—Ä–≤–µ—Ä –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–ª—é—á –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏

### –î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏

**–°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–æ—Ä–º–∞–ª—å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞**
```
1. enqueue_sync() –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç idempotency_key = hash(entity_type + payload)
2. INSERT —Å idempotency_key
3. sync_task() –ø–æ–ª—É—á–∞–µ—Ç idempotency_key –∏–∑ –ë–î
4. HTTP –∑–∞–ø—Ä–æ—Å —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º X-Idempotency-Key
5. –°–µ—Ä–≤–µ—Ä –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å
6. –î–û–ö–ê–ó–ê–ù–û: –°–µ—Ä–≤–µ—Ä –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–ª—é—á –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏
```

**–°—Ü–µ–Ω–∞—Ä–∏–π 2: Retry –ø–æ—Å–ª–µ HTTP success**
```
1. HTTP 200 OK
2. mark_task_sent() fails
3. –ó–∞–¥–∞—á–∞ –æ—Å—Ç–∞–µ—Ç—Å—è pending
4. –°–ª–µ–¥—É—é—â–∏–π sync: HTTP –∑–∞–ø—Ä–æ—Å —Å –¢–ï–ú –ñ–ï idempotency_key
5. –°–µ—Ä–≤–µ—Ä –≤–∏–¥–∏—Ç —Ç–æ—Ç –∂–µ –∫–ª—é—á
6. –î–û–ö–ê–ó–ê–ù–û: –°–µ—Ä–≤–µ—Ä –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å —Ç–æ—Ç –∂–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±–µ–∑ —Å–æ–∑–¥–∞–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–∞
```

**–°—Ü–µ–Ω–∞—Ä–∏–π 3: –û–¥–∏–Ω–∞–∫–æ–≤—ã–µ –∑–∞–¥–∞—á–∏**
```
1. enqueue_sync("time_entry_start", payload1)
2. idempotency_key1 = hash("time_entry_start" + payload1)
3. enqueue_sync("time_entry_start", payload1) (–¥—É–±–ª–∏–∫–∞—Ç)
4. idempotency_key2 = hash("time_entry_start" + payload1)
5. idempotency_key1 == idempotency_key2
6. –î–û–ö–ê–ó–ê–ù–û: –û–¥–∏–Ω–∞–∫–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ –∏–º–µ—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –∫–ª—é—á
```

**–°—Ü–µ–Ω–∞—Ä–∏–π 4: –†–∞–∑–Ω—ã–µ –∑–∞–¥–∞—á–∏**
```
1. enqueue_sync("time_entry_start", payload1)
2. idempotency_key1 = hash("time_entry_start" + payload1)
3. enqueue_sync("time_entry_start", payload2) (—Ä–∞–∑–Ω—ã–π payload)
4. idempotency_key2 = hash("time_entry_start" + payload2)
5. idempotency_key1 != idempotency_key2
6. –î–û–ö–ê–ó–ê–ù–û: –†–∞–∑–Ω—ã–µ –∑–∞–¥–∞—á–∏ –∏–º–µ—é—Ç —Ä–∞–∑–Ω—ã–µ –∫–ª—é—á–∏
```

**–í–´–í–û–î:** ‚úÖ **–î–û–ö–ê–ó–ê–ù–û** - Idempotency keys –ø–æ–∑–≤–æ–ª—è—é—Ç —Å–µ—Ä–≤–µ—Ä—É –¥–µ–¥—É–ø–ª–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã. –û–¥–∏–Ω–∞–∫–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ –∏–º–µ—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –∫–ª—é—á, —Ä–∞–∑–Ω—ã–µ –∑–∞–¥–∞—á–∏ - —Ä–∞–∑–Ω—ã–µ –∫–ª—é—á–∏.

**–ü–†–ò–ú–ï–ß–ê–ù–ò–ï:** –î–ª—è –ø–æ–ª–Ω–æ–π –∑–∞—â–∏—Ç—ã –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ —Å–µ—Ä–≤–µ—Ä –î–û–õ–ñ–ï–ù —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é –ø–æ idempotency_key. –ö–ª–∏–µ–Ω—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∫–ª—é—á, –Ω–æ –Ω–µ –º–æ–∂–µ—Ç –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é –±–µ–∑ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞.

---

## üìä –ò–¢–û–ì–û–í–ê–Ø –û–¶–ï–ù–ö–ê

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π: **45/100** (UNSAFE)
- Timer: –ø–µ—Ä–µ—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏ crash
- Sync: –ø–æ—Ç–µ—Ä—è –∑–∞–¥–∞—á –ø—Ä–∏ crash
- Sync: –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ—Å–ª–µ HTTP success
- Recovery: clock skew –≤—ã–∑—ã–≤–∞–µ—Ç –ø–æ—Ç–µ—Ä—é/–ø–µ—Ä–µ—Å—á–µ—Ç
- Idempotency: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π: **85/100** (CONDITIONALLY SAFE)

**–£–ª—É—á—à–µ–Ω–∏—è:**
- ‚úÖ Timer: –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞
- ‚úÖ Sync: —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç –ø–æ—Ç–µ—Ä—é –∑–∞–¥–∞—á
- ‚úÖ Sync: retry —Å–Ω–∏–∂–∞–µ—Ç –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
- ‚úÖ Recovery: clock skew detection –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–æ—Ç–µ—Ä—é/–ø–µ—Ä–µ—Å—á–µ—Ç
- ‚úÖ Idempotency: –∫–ª—é—á–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω—ã (—Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞)

**–û—Å—Ç–∞–≤—à–∏–µ—Å—è —Ä–∏—Å–∫–∏:**
- üü° mark_task_sent() failure –ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫ ‚Üí –≤–æ–∑–º–æ–∂–µ–Ω –¥—É–±–ª–∏–∫–∞—Ç (–Ω–æ –∑–∞–¥–∞—á–∞ –Ω–µ –ø–æ—Ç–µ—Ä—è–Ω–∞)
- üü° Idempotency —Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞ (–∫–ª–∏–µ–Ω—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∫–ª—é—á)
- üü° –î–ª–∏—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã (> 24h) –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ–¥–æ—É—á—Ç–µ–Ω—ã (edge case)

**–í–´–í–û–î:** ‚úÖ **–î–û–ö–ê–ó–ê–ù–û** - –°–∏—Å—Ç–µ–º–∞ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–ª—É—á—à–µ–Ω–∞. –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã —Å —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–º–∏ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞–º–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏. –û—Å—Ç–∞–≤—à–∏–µ—Å—è —Ä–∏—Å–∫–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã –∏ —Ç—Ä–µ–±—É—é—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞, –∞ –Ω–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π.

---

**Audit Completed:** 2025-01-12  
**All Fixes Applied:** ‚úÖ  
**Compilation Status:** ‚úÖ Success  
**Proof Status:** ‚úÖ All fixes proven correct
