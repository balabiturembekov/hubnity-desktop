# ПЛАН ПЕРЕХОДА К PRODUCTION-GRADE СИНХРОНИЗАЦИИ

**Статус:** В разработке  
**Приоритет:** Критический

---

## АРХИТЕКТУРНЫЕ ИЗМЕНЕНИЯ

### 1. AuthManager (✅ Начато)
- Получение токенов из secure storage (Keychain для macOS)
- Проверка expiry и автоматическое обновление
- **Проблема:** Текущая реализация требует токены от frontend
- **Решение:** Создать Tauri команду для получения токенов из localStorage (временное решение) или использовать Keychain

### 2. Sync Lock (✅ Начато)
- `Arc<tokio::sync::Mutex<()>>` для single-flight
- `Arc<AtomicBool>` для быстрой проверки
- **Статус:** Структура создана, нужно интегрировать в `sync_queue()`

### 3. Убрать токены из payload
- Миграция БД: удалить `accessToken`, `refreshToken`, `_encrypted` из payload
- Обновить `enqueue_time_entry()` - не сохранять токены
- Обновить `sync_task()` - получать токены через AuthManager

### 4. Адаптивный batch processing
- Увеличить LIMIT с 10 до адаптивного (10 → 50 → 100)
- Partial success: удалять успешные задачи сразу
- Очистка sent задач (старше 7 дней)

### 5. Приоритеты задач
- Добавить колонку `priority` в БД
- Обновить `get_retry_tasks()` для сортировки по приоритету
- Лимит очереди: 10_000 задач

### 6. Обновить все точки входа
- `sync_queue()` - добавить sync-lock
- `sync_queue_now()` - использовать sync-lock
- `retry_failed_tasks()` - использовать sync-lock
- Background job - использовать sync-lock

---

## ПОРЯДОК РЕАЛИЗАЦИИ

### Этап 1: Базовая инфраструктура (В ПРОЦЕССЕ)
1. ✅ Создать AuthManager
2. ✅ Добавить sync-lock в SyncManager
3. ⏳ Исправить компиляцию (обновить все создания SyncManager)
4. ⏳ Создать Tauri команду для получения токенов

### Этап 2: Убрать токены из payload
1. Миграция БД: добавить колонку `priority`
2. Обновить `enqueue_time_entry()` - убрать токены
3. Обновить `sync_task()` - использовать AuthManager
4. Обновить тесты

### Этап 3: Адаптивный batch processing
1. Обновить `get_retry_tasks()` - адаптивный LIMIT
2. Partial success в `sync_queue()`
3. Очистка sent задач

### Этап 4: Приоритеты и лимиты
1. Добавить приоритеты в `enqueue_sync()`
2. Обновить `get_retry_tasks()` для сортировки
3. Добавить лимит очереди (10_000)

### Этап 5: Интеграция sync-lock
1. Обновить `sync_queue()` - использовать lock
2. Обновить все точки входа
3. Тестирование

---

## ТЕКУЩИЕ ПРОБЛЕМЫ

1. **Компиляция:** `SyncManager::new()` не обновлен в тестах
2. **Токены:** Нет способа получить токены из Rust (нужна Tauri команда)
3. **Миграция БД:** Нужна миграция для удаления токенов из payload

---

## СЛЕДУЮЩИЕ ШАГИ

1. Исправить компиляцию (обновить все `SyncManager::new()`)
2. Создать Tauri команду `get_auth_tokens()` для получения токенов из localStorage
3. Обновить `enqueue_time_entry()` - убрать токены
4. Обновить `sync_task()` - использовать AuthManager

---

**Дата создания:** 2025-01-08
