# macOS Background Timer Audit

## Проблема

На macOS таймер самопроизвольно ставится на паузу, когда окно приложения скрыто или минимизировано.

## Аудит

### 1. App Nap

**Влияние:** App Nap приостанавливает весь процесс приложения, включая все потоки (в т.ч. tokio runtime). Таймер и монитор активности перестают выполняться.

**Решение:**
- `macos-app-nap::prevent()` вызывается при старте приложения в `lib.rs` setup hook.
- В `Info.plist` добавлен `NSAppSleepDisabled = true` как fallback (на современных macOS может игнорироваться, но не вредит).

**Файлы:**
- `src-tauri/src/lib.rs` — вызов `macos_app_nap::prevent()` в `#[cfg(target_os = "macos")]`.
- `src-tauri/Info.plist` — ключ `NSAppSleepDisabled`.
- `src-tauri/Cargo.toml` — зависимость `macos-app-nap = "0.0.1"`.

### 2. Idle Time (IOKit vs события окна)

**Реализация:** Используется крейт `system-idle-time`, который на macOS опирается на Core Foundation / IOKit (`IOHIDSystem`, `HIDIdleTime`).

**Вывод:** Idle time получается через системные API, а не через события окна. Работает корректно при скрытом/минимизированном окне.

**Код:** `src-tauri/src/commands.rs`, `start_activity_monitoring` — вызов `system_idle_time::get_idle_time()`.

### 3. Системный сон

**Поведение:** При переходе Mac в сон весь процесс приостанавливается. После пробуждения процесс возобновляется.

**Обработка:** `TimerEngine` в `get_state` учитывает разрыв времени (sleep/wake) и корректно обрабатывает паузы. Мониторинг активности продолжает работать после пробуждения.

**Примечание:** `NSActivityUserInitiatedAllowingIdleSystemSleep` (используется в macos-app-nap) не блокирует системный сон — только App Nap.

### 4. Гарантия работы в фоне

| Условие | Результат |
|---------|-----------|
| Окно скрыто/минимизировано | ✅ Работает (App Nap отключён) |
| Приложение в фоне | ✅ Работает |
| Системный сон | ⏸️ Приостановка, корректное восстановление после пробуждения |

## Рекомендации

- Не отключать App Nap prevention — иначе таймер будет останавливаться в фоне.
- При необходимости более тонкого контроля (включать только при активном таймере) можно заменить `macos-app-nap` на собственный модуль с `NSProcessInfo::beginActivityWithOptions` / `endActivity:`.
