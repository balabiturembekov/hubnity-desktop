# Security & QA Audit Report — Hubnity

Роль: Senior QA & Rust Security Engineer.  
Дата: 2026-02-10.

---

## Критичные / высокий приоритет

### 1. Дефолтный ключ шифрования токенов (Security)

**Файл:** `src-tauri/src/auth.rs` (TokenEncryption::new)

**Проблема:** В production используется захардкоженный ключ `b"default-encryption-key-32-bytes!"`, если не задана переменная окружения `HUBNITY_ENCRYPTION_KEY`. Токены в SQLite тогда шифруются предсказуемым ключом — при доступе к БД их можно расшифровать.

**Рекомендация:** В production обязательно задавать `HUBNITY_ENCRYPTION_KEY` (32 байта, hex). В коде оставить явный `return Err(...)` при отсутствии ключа в production (например, по feature или env `HUBNITY_PRODUCTION=1`), чтобы не запускаться с дефолтным ключом.

---

### 2. Отсутствие CSP (Content-Security-Policy)

**Файл:** `src-tauri/tauri.conf.json` → `app.windows[].security.csp: null`

**Проблема:** Для webview не задаётся CSP. В случае XSS (например, через уязвимую зависимость или инъекцию в отображаемые данные) возможны выполнение скриптов и доступ к `invoke()`.

**Рекомендация:** Задать строгий CSP, например: `default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; connect-src 'self' https://app.automatonsoft.de; img-src 'self' data: https:;` и сужать по мере необходимости.

---

## Средний приоритет

### 3. Нет лимита размера тела скриншота в Rust (DoS / OOM) — исправлено

**Файл:** `src-tauri/src/commands.rs` → `upload_screenshot(png_data: Vec<u8>, ...)`

**Проблема:** Фронт может передать сколь угодно большой `png_data`. Нет проверки размера в команде — возможны исчерпание памяти и DoS.

**Исправление:** В команду добавлена константа `MAX_SCREENSHOT_BODY_BYTES = 15 MB` и проверка в начале; при превышении возвращается ошибка.

---

### 4. log_message принимает произвольную строку (Log injection)

**Файл:** `src-tauri/src/commands.rs` → `log_message(message: String)`

**Проблема:** Сообщение выводится в stderr без санитизации. Теоретически возможна подмена строк в логах (например, переводы строк и поддельные записи), если в message попадёт управляемый злоумышленником ввод.

**Рекомендация:** Ограничить использование `log_message` только доверенным кодом приложения; не логировать в Rust произвольный пользовательский ввод. При необходимости — санитизировать (удалять/экранировать `\n`, `\r`) или ограничивать длину.

---

### 5. Idle-окно и права (Capabilities)

**Файл:** `src-tauri/capabilities/idle.json` → `"app-commands"`

**Проблема:** В capability для idle-окна указан доступ к app-commands. Нужно явно ограничить список разрешённых команд только теми, что нужны idle-окну (например, `request_idle_state`, `resume_tracking_from_idle`, `stop_tracking_from_idle`, `update_idle_state`), чтобы при возможном XSS в этом окне нельзя было вызывать чувствительные команды (например, `set_auth_tokens`).

**Рекомендация:** Заменить общий `app-commands` на явный список разрешённых команд для окна idle.

---

## Низкий приоритет / заметки

### 6. Unsafe в commands.rs (macOS)

**Файл:** `src-tauri/src/commands.rs` (activity monitoring, NSEvent.mouseLocation)

**Статус:** Один блок `unsafe` для вызова macOS objc (NSEvent, mouseLocation). Использование типичное для FFI, входные данные не приходят от пользователя. Риск низкий при корректной сборке под macOS.

---

### 7. SQL-запросы

**Файлы:** `src-tauri/src/database.rs`, использование в sync/engine

**Статус:** Запросы строятся через параметризацию (`params!`, `query_row` и т.д.), конкатенации SQL со строками от пользователя нет. Признаков SQL-инъекций не найдено.

---

### 8. Ошибки в production Rust

**Статус:** В production-коде (кроме `tests.rs`) используются `?` и `map_err`, без необоснованных `unwrap()`/`expect()`. Паники в production не ожидаются от текущего кода.

---

### 9. XSS на фронте

**Статус:** В Login ошибка от API санитизируется (`errorMessage.replace(/<[^>]*>/g, '')`). Не обнаружено использования `dangerouslySetInnerHTML` или вставки сырого HTML. React по умолчанию экранирует текст в JSX.

---

### 10. API URL и SSRF

**Статус:** URL API задаётся в конфиге по умолчанию в Rust и константой на фронте, не строится из пользовательского ввода. Признаков SSRF в текущем коде нет.

---

## Резюме

| # | Уровень   | Тема                          | Действие                    |
|---|-----------|-------------------------------|-----------------------------|
| 1 | Высокий   | Дефолтный ключ шифрования    | Обязательный ключ в prod   |
| 2 | Высокий   | Нет CSP                      | Включить строгий CSP       |
| 3 | Средний   | Лимит размера скриншота      | Исправлено (15 MB в Rust)  |
| 4 | Средний   | log_message                  | Не логировать непроверенный ввод |
| 5 | Средний   | Capabilities idle-окна       | Сузить список команд       |
| 6–10 | Низкий/OK | Остальное                  | Мониторинг / без изменений |
