# –û–°–¢–ê–í–®–ò–ï–°–Ø –§–ò–ö–°–´ –ü–û –ß–ï–ö-–õ–ò–°–¢–£

**–î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏:** 2025-01-08  
**–°—Ç–∞—Ç—É—Å:** –ß–∞—Å—Ç–∏—á–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ

---

## ‚úÖ –ü–†–ò–ú–ï–ù–ï–ù–ù–´–ï –§–ò–ö–°–´

### ‚úÖ CRITICAL FIX #1: System Clock Skew Detection
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–æ
- **–î–æ–∫—É–º–µ–Ω—Ç:** `CLOCK_SKEW_FIX.md`
- **–ü—Ä–æ–≤–µ—Ä–∫–∞:** Clock skew detection –≤ `rollover_day()` —Ä–∞–±–æ—Ç–∞–µ—Ç
- **–ö–æ–¥:** `src-tauri/src/lib.rs:2454-2530`

### ‚úÖ CRITICAL FIX #2: Timezone UTC Protection
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–æ
- **–î–æ–∫—É–º–µ–Ω—Ç:** `TIMEZONE_UTC_FIX.md`
- **–ü—Ä–æ–≤–µ—Ä–∫–∞:** –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç `Utc::now()` (7 –º–µ—Å—Ç)
- **–ö–æ–¥:** `src-tauri/src/lib.rs:2366-2418, 2427-2585`

### ‚úÖ CRITICAL FIX #3: SQLite Transactional Safety
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–æ
- **–î–æ–∫—É–º–µ–Ω—Ç:** `SQLITE_TRANSACTIONAL_FIX.md`
- **–ü—Ä–æ–≤–µ—Ä–∫–∞:** –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è (BEGIN/COMMIT/ROLLBACK)
- **–ö–æ–¥:** `src-tauri/src/lib.rs:1179-1229`

### ‚úÖ HIGH FIX #4: Recursive get_state() Protection
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–æ
- **–ü—Ä–æ–≤–µ—Ä–∫–∞:** `MAX_RECURSION_DEPTH = 3` —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- **–ö–æ–¥:** `src-tauri/src/lib.rs:2320-2333`
- **–î–µ—Ç–∞–ª–∏:**
  - `get_state_internal(depth: u8)` —Å depth tracking
  - Guard –Ω–∞ `depth > MAX_RECURSION_DEPTH`
  - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏

### ‚úÖ HIGH FIX #5: Rollover Idempotency Protection
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–æ
- **–ü—Ä–æ–≤–µ—Ä–∫–∞:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã rollover —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞
- **–ö–æ–¥:** `src-tauri/src/lib.rs:2620-2638`
- **–î–µ—Ç–∞–ª–∏:**
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ `current_day == new_day` –ø–µ—Ä–µ–¥ rollover
  - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –ø—Ä–∏ –¥—É–±–ª–∏–∫–∞—Ç–∞—Ö
  - –í–æ–∑–≤—Ä–∞—Ç `Ok(())` –±–µ–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è rollover

---

## ‚ö†Ô∏è –ß–ê–°–¢–ò–ß–ù–û –ü–†–ò–ú–ï–ù–ï–ù–ù–´–ï –§–ò–ö–°–´

### ‚ö†Ô∏è HIGH FIX #6: False-Positive Sleep Detection

**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ

**–ß—Ç–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ:**
- ‚úÖ Sleep detection —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–∞—É–∑–∞ –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ sleep
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π

**–ß—Ç–æ –ù–ï –ø—Ä–∏–º–µ–Ω–µ–Ω–æ:**
- ‚ùå Threshold = 5 –º–∏–Ω—É—Ç (–≤ HARDENING_FIXES.md –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç—Å—è 10 –º–∏–Ω—É—Ç)
- ‚ùå –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –º—ã—à–∏/–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –ø–µ—Ä–µ–¥ –ø–∞—É–∑–æ–π
- ‚ùå –ù–µ—Ç –æ–ø—Ü–∏–∏ "—Ç–æ–ª—å–∫–æ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å, –Ω–µ –ø–∞—É–∑–∏—Ç—å"

**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**
```rust
// src-tauri/src/lib.rs:2366
const SLEEP_DETECTION_THRESHOLD_SECONDS: u64 = 5 * 60; // 5 –º–∏–Ω—É—Ç
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –∏–∑ HARDENING_FIXES.md:**
```rust
const SLEEP_DETECTION_THRESHOLD_SECONDS: u64 = 10 * 60; // 10 –º–∏–Ω—É—Ç –≤–º–µ—Å—Ç–æ 5
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** MEDIUM (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å —É–ª—É—á—à–µ–Ω–æ)

---

## üìã –ò–¢–û–ì–û–í–ê–Ø –°–í–û–î–ö–ê

| –§–∏–∫—Å | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|------|-----------|--------|-------------|
| #1: Clock Skew Detection | CRITICAL | ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–æ | –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |
| #2: Timezone UTC Protection | CRITICAL | ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–æ | –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |
| #3: SQLite Transactional Safety | CRITICAL | ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–æ | –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |
| #4: Recursive get_state() Protection | HIGH | ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–æ | –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |
| #5: Rollover Idempotency | HIGH | ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–æ | –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |
| #6: False-Positive Sleep Detection | HIGH | ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ | Threshold –º–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å –¥–æ 10 –º–∏–Ω—É—Ç |

---

## üéØ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### 1. –£–≤–µ–ª–∏—á–∏—Ç—å Sleep Detection Threshold (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–î–µ–π—Å—Ç–≤–∏–µ:** –ò–∑–º–µ–Ω–∏—Ç—å `SLEEP_DETECTION_THRESHOLD_SECONDS` —Å 5 –¥–æ 10 –º–∏–Ω—É—Ç

**–ö–æ–¥:**
```rust
// src-tauri/src/lib.rs:2366
const SLEEP_DETECTION_THRESHOLD_SECONDS: u64 = 10 * 60; // 10 –º–∏–Ω—É—Ç
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** MEDIUM (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, —Ç–µ–∫—É—â–∏–π threshold —Ä–∞–±–æ—Ç–∞–µ—Ç)

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**
- –¢–µ–∫—É—â–∏–π threshold (5 –º–∏–Ω—É—Ç) –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–ª–∏—à–∫–æ–º –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–º
- 10 –º–∏–Ω—É—Ç –¥–∞—Å—Ç –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã –±–µ–∑ –ø–∞—É–∑—ã
- –ù–æ 5 –º–∏–Ω—É—Ç —Ç–æ–∂–µ –ø—Ä–∏–µ–º–ª–µ–º–æ –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å–ª—É—á–∞–µ–≤

---

## ‚úÖ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

**–í—Å–µ CRITICAL —Ñ–∏–∫—Å—ã –ø—Ä–∏–º–µ–Ω–µ–Ω—ã:** ‚úÖ  
**–í—Å–µ HIGH —Ñ–∏–∫—Å—ã –ø—Ä–∏–º–µ–Ω–µ–Ω—ã:** ‚úÖ (–∫—Ä–æ–º–µ —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ —É–ª—É—á—à–µ–Ω–∏—è #6)

**–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ production:** ‚úÖ

**–û—Å—Ç–∞–≤—à–∏–µ—Å—è –∑–∞–¥–∞—á–∏:**
- ‚ö†Ô∏è –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –£–≤–µ–ª–∏—á–∏—Ç—å sleep detection threshold –¥–æ 10 –º–∏–Ω—É—Ç (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)

---

**–û—Ç—á–µ—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω:** 2025-01-08  
**–í—Å–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –∏ –≤—ã—Å–æ–∫–æ–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ —Ñ–∏–∫—Å—ã –ø—Ä–∏–º–µ–Ω–µ–Ω—ã**
